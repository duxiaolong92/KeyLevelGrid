# Key Level Grid TG 交互需求规格说明书 (V3.2.1)

## 1. 交互设计原则
- 菜单化操作：以 Inline Keyboards (按钮) 为主，文本指令为辅。
- 二次确认制：涉及资金、重置、重构的高危操作必须弹出二次确认。
- 状态透明化：持仓、挂单、系统异常变化必须实时推送。

## 2. 菜单结构与指令定义

### 2.1 主菜单 (Home Dashboard)
- 唤起方式：/start 或 /menu。
- 展示内容：
  - 运行状态：运行中/已停止、保证金模式、当前杠杆。
  - 账户权益：总余额 (Equity)、可用余额。
  - 持仓快照：持仓数量、持仓均价、未实现盈亏 (uPNL)。
  - 风险预警：当前止损触发价 (跌破网格底线 X%)。
- 一级按钮组：
  - [📊 实时监控]
  - [⚙️ 策略设置]
  - [🛠 系统运维]
  - [🚨 紧急全平]

### 2.2 二级功能列表

#### A. [📊 实时监控] (Monitoring)
- 挂单分布：展示所有活跃支撑位买单、阻力位卖单（含价格、数量、当前计数/最大配额）。
- 水位画像：展示网格区间内全部支撑位得分及核心指标（示例：96000 | Score: 85 | Fibo+POC）。
- 操作按钮：[🔄 刷新数据]、[🏠 返回主菜单]。

#### B. [⚙️ 策略设置] (Strategy Config)
- 网格区间：输入 最低价-最高价。
- 底仓保留：比例按钮 [0%] [10%] [30%] [50%]。
- 全局止损：输入跌破网格百分比止损（如 1 代表 1%）。
- 杠杆/模式：
  - 逻辑拦截：有持仓提示“仅支持在没有持仓情况下修改”；无持仓可修改。

#### C. [🛠 系统运维] (DevOps)
- 智能对账 (Deep Recon)：触发一次全局同步，强制校准实盘与系统状态。
- 计数重置 (Counter Reset)：
  - 二次确认：提示“计数重置后，每个支撑位的成交次数将清零”。
  - 确认后动作：fill_counter 全量清零。
- 网格重构 (Grid Regenerate)：
  - 二次确认：提示“系统将重新计算支撑位和阻力位，更新所有网格挂单”。
  - 确认后动作：重新划定坐标，撤旧挂新。
- 日志提取：查询最近 5 条系统运行日志（含异常堆栈）。

#### D. [🚨 紧急全平] (Risk Guard)
- 二次确认：提示“警告：将立即平仓所有头寸并撤销所有挂单”。
- 确认后动作：市价全平 + 撤销所有委托 + 机器人进入 STOP 状态。

## 3. 全量事件通知规范 (Notifications)

### 3.1 交易行为通知
- 成交提醒：支撑位/阻力位成交。
- 持仓变更：任何导致持仓变化的动作。
- 挂单同步：Recon 轨道调整挂单。

### 3.2 风险与异常通知
- 警告 (Warning)：价格接近止损线、缓冲区失效。
- 告警 (Alert)：API 报错、WS 断线、余额不足。

## 4. 给 AI 的核心开发指令 (Final Implementation)
- 文案对齐：水位文案统一为“支撑位/阻力位”。
- 异步安全：按钮触发操作必须获取 GridLock，避免与 Recon 冲突。
- 持久化联动：TG 端修改参数需写入 config.json 并重载。
- 异常捕获：主程序 try-except 中集成 TG 告警推送。
- 交互拦截：杠杆修改需检查持仓，持仓>0则拒绝。
