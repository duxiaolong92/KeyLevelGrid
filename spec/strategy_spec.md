# Key Level Grid Strategy 策略规格文档

## 概述

**Key Level Grid** 是一个基于支撑位/阻力位的智能网格交易策略，专为加密货币永续合约设计。

### 核心理念

- **关键价位交易**：在技术分析识别的支撑位挂买单，阻力位挂卖单
- **多周期融合**：结合主周期和辅助周期，增强关键价位的可靠性
- **智能仓位管理**：根据支撑位强度分配仓位，强支撑位获得更大配额
- **风险控制**：跌破网格底线统一止损，保护本金

### 适用场景

- 震荡市场中的网格套利
- 趋势回调时的分批建仓
- 关键价位的突破/反弹交易

---

## 一、策略架构

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    Key Level Grid Strategy                   │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │  Kline Feed  │───▶│  Resistance  │───▶│   Position   │  │
│  │  (Binance)   │    │  Calculator  │    │   Manager    │  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
│         │                   │                   │           │
│         ▼                   ▼                   ▼           │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐  │
│  │  Indicator   │    │   Grid       │    │   Executor   │  │
│  │  Calculator  │    │   Builder    │    │   (Gate.io)  │  │
│  └──────────────┘    └──────────────┘    └──────────────┘  │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              Telegram Bot (通知 & 交互)               │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 模块职责

| 模块 | 文件 | 职责 |
|------|------|------|
| **策略核心** | `strategy.py` | 主流程控制、网格创建/重建、订单管理 |
| **K线数据源** | `kline_feed.py` | 从 Binance 获取多周期 K 线数据 |
| **阻力位计算** | `resistance.py` | 计算支撑/阻力位（SW, FIB, VOL, PSY） |
| **仓位管理** | `position.py` | 网格状态管理、仓位计算、状态持久化 |
| **订单执行** | `executor/gate_executor.py` | Gate.io 订单提交、查询、取消 |
| **Telegram** | `telegram/bot.py` | 通知推送、命令交互 |

### 1.3 数据流

```
1. Binance WebSocket → K线数据 (多周期)
2. K线数据 → 技术指标计算 → 支撑/阻力位识别
3. 支撑/阻力位 → 网格构建 → 买卖挂单列表
4. 挂单列表 → Gate.io Executor → 交易所订单
5. 订单状态变化 → Telegram 通知
```

---

## 二、关键价位识别

### 2.1 价位来源

策略使用四种方法识别关键价位：

| 来源 | 代码标识 | 说明 | 基础权重 |
|------|----------|------|----------|
| **摆动点** | `swing_*` | 历史高低点（多尺度） | 25-35 |
| **斐波那契** | `fib_*` | 回撤/扩展比例 | 15-20 |
| **成交量密集区** | `volume_node` | 高成交量价格区间 | 15-25 |
| **心理关口** | `round_number` | 整数价位 | 10-15 |

### 2.2 摆动点识别

使用三尺度 Lookback 识别不同级别的摆动高低点：

```python
swing_lookbacks = [5, 13, 34]  # 短期、中期、长期
```

**识别逻辑**：
- 摆动高点：当前 K 线高点 > 前后 N 根 K 线的高点
- 摆动低点：当前 K 线低点 < 前后 N 根 K 线的低点

### 2.3 斐波那契回撤

基于近期波段高低点计算斐波那契比例：

```python
fib_ratios = [0.382, 0.5, 0.618, 1.0, 1.618]
```

### 2.4 成交量密集区

将价格区间分桶，统计每个价格区间的成交量：

```python
volume_buckets = 50    # 价格分桶数
volume_top_n = 5       # 取 Top N 成交量节点
```

### 2.5 心理关口

识别整数价位（如 90000, 91000, 92000...）：

```python
# BTC: 每 1000 美元
# ETH: 每 100 美元
```

### 2.6 多周期融合

当主周期和辅助周期在相近价位都识别出关键位时，强度叠加：

```
主周期 (4h): 支撑位 @ 89,500 (强度 80)
辅助周期 (1d): 支撑位 @ 89,600 (强度 75)

融合后: 支撑位 @ 89,550 (强度 80 × 1.2 + 75 × 1.2 × 0.5 = 141)
```

### 2.7 强度评分

最终强度 = 基础权重 × 时效衰减 × 周期加成

| 因素 | 说明 |
|------|------|
| 基础权重 | 根据来源类型 15-35 |
| 时效衰减 | 越近期权重越高 |
| 周期加成 | 日线级别 ×1.2 |
| 多源叠加 | 多个来源在同一价位 |

**最小强度阈值**：默认 80 分，低于此分数的价位不参与网格

---

## 三、网格构建

### 3.1 网格结构

```
上边界 (阻力位)  ─────────────── R2: 93,000 (卖单)
                               R1: 91,500 (卖单)
─────────────────────────────── 当前价格: 90,500
                               S1: 89,600 (买单)
                               S2: 88,800 (买单)
                               S3: 88,000 (买单)
下边界 (支撑位)  ─────────────── 
网格底线 (止损)  ─────────────── Floor: 87,560 (S3 - 0.5%)
```

### 3.2 网格区间计算

**自动模式** (`range_mode: auto`):
- 上边界：最高阻力位
- 下边界：最低支撑位
- 网格底线：最低支撑位 × (1 - floor_buffer)

**手动模式** (`range_mode: manual`):
```yaml
manual_upper: 95000
manual_lower: 87000
```

### 3.3 仓位分配

**等额分配** (`allocation_mode: equal`):
```
每档仓位 = (total_capital × leverage × max_capital_usage) / 网格数量

示例:
- 总资金: 5000 USDT
- 杠杆: 10x
- 使用率: 80%
- 网格数: 5

每档仓位 = 5000 × 10 × 0.8 / 5 = 8000 USDT
```

**加权分配** (`allocation_mode: weighted`):
- 强度越高的支撑位，分配更多仓位
- 底部档位分配更少（防止深套）

### 3.4 合约张数计算

```python
contracts = floor(position_usdt / (price × contract_size))

示例:
- 仓位: 800 USDT
- 价格: 90,000
- 合约大小: 0.0001 BTC

contracts = floor(800 / (90000 × 0.0001)) = 88 张
```

---

## 四、订单管理

### 4.1 买单（支撑位）

| 属性 | 说明 |
|------|------|
| 类型 | 限价单 (Limit) |
| 方向 | 买入做多 |
| 价格 | 支撑位价格 |
| 数量 | 按仓位分配计算 |

### 4.2 卖单（阻力位）

| 属性 | 说明 |
|------|------|
| 类型 | 限价单 (Limit, Reduce-Only) |
| 方向 | 卖出平多 |
| 价格 | 阻力位价格 |
| 数量 | 当前持仓 / 阻力位数量 |

### 4.3 止损单

| 属性 | 说明 |
|------|------|
| 类型 | 市价止损 (Stop Market) |
| 触发价 | 网格底线 |
| 数量 | 全部持仓 |

### 4.4 订单状态同步

```
1. 启动时同步交易所挂单
2. 对比本地状态与交易所状态
3. 增量更新：只撤销不匹配的旧单
4. 避免盲目全撤导致止盈止损丢失
```

---

## 五、网格重建

### 5.1 触发条件

当价格大幅偏离锚点时自动重建：

```yaml
rebuild_enabled: true
rebuild_threshold_pct: 0.02   # 价格偏离 2%
rebuild_cooldown_sec: 900     # 冷却 15 分钟
```

**重建判断**：
```python
price_change = abs(current_price - anchor_price) / anchor_price
if price_change >= rebuild_threshold_pct:
    rebuild_grid()
```

### 5.2 重建流程

```
1. 撤销所有现有挂单
2. 重新获取最新 K 线
3. 重新计算支撑/阻力位
4. 构建新网格
5. 提交新挂单
6. 更新锚点价格和时间戳
7. 发送 Telegram 通知
```

### 5.3 手动重建

通过 Telegram Bot 菜单点击 "🔄 更新网格" 可强制重建：
- 不检查冷却时间
- 不检查偏离阈值
- 立即执行重建

---

## 六、风险控制

### 6.1 止损机制

**总仓位止损** (`mode: total`):
- 触发条件：价格跌破网格底线
- 执行动作：市价平掉全部持仓
- 止损价格：最低支撑位 × (1 - floor_buffer)

### 6.2 仓位限制

```yaml
max_capital_usage: 0.8    # 最多使用 80% 资金
max_grids: 20             # 最多 20 档网格
```

### 6.3 余额检查

下单前检查可用余额是否足够：
- 余额不足时跳过该订单
- 记录错误日志
- 不中断策略运行

### 6.4 风险预警

通过 Telegram 发送风险预警：
- 价格距止损线 < 2%
- 未实现亏损超过阈值
- 可用余额不足

---

## 七、状态持久化

### 7.1 状态文件

```
state/key_level_grid/{symbol}_state.json
```

### 7.2 保存内容

```json
{
  "symbol": "BTCUSDT",
  "direction": "long",
  "upper_price": 93000.0,
  "lower_price": 88000.0,
  "grid_floor": 87560.0,
  "buy_orders": [...],
  "sell_orders": [...],
  "per_grid_contracts": 88,
  "anchor_price": 90500.0,
  "anchor_ts": 1736445600,
  "resistance_levels": [...],
  "support_levels": [...]
}
```

### 7.3 恢复逻辑

1. 启动时检查状态文件
2. 如存在，恢复网格配置
3. 同步交易所真实挂单
4. 增量更新

### 7.4 注意事项

- 修改配置后，旧状态会被恢复
- 如需使用新配置，需删除状态文件或点击"更新网格"

---

## 八、Telegram 交互

### 8.1 命令菜单

| 按钮 | 功能 |
|------|------|
| 📊 当前持仓 | 查看持仓详情 |
| 📋 当前挂单 | 查看挂单列表 |
| 📍 关键价位 | 查看支撑/阻力位 |
| 🔄 更新网格 | 强制重建网格 |

### 8.2 通知类型

| 类型 | 触发时机 |
|------|----------|
| 🚀 启动通知 | 策略启动完成 |
| ✅ 成交通知 | 订单成交 |
| 🔄 重建通知 | 网格重建 |
| ❌ 错误通知 | 系统异常 |
| ⚠️ 风险预警 | 接近止损 |

---

## 九、配置参数

### 9.1 核心参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `trading.symbol` | BTCUSDT | 交易对 |
| `trading.leverage` | 10 | 杠杆倍数 |
| `trading.timeframe` | 4h | 主周期 |
| `trading.aux_timeframes` | [1d] | 辅助周期 |

### 9.2 网格参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `grid.max_grids` | 20 | 最大网格数 |
| `grid.floor_buffer` | 0.005 | 底线缓冲 0.5% |
| `grid.rebuild_threshold_pct` | 0.02 | 重建阈值 2% |
| `grid.rebuild_cooldown_sec` | 900 | 重建冷却 15分钟 |

### 9.3 仓位参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `position.total_capital` | 5000 | 总资金 USDT |
| `position.max_capital_usage` | 0.8 | 使用率 80% |
| `position.allocation_mode` | equal | 分配模式 |

### 9.4 阻力位参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `resistance.min_strength` | 80 | 最小强度 |
| `resistance.swing_lookbacks` | [5,13,34] | 摆动点尺度 |
| `resistance.merge_tolerance` | 0.005 | 合并容差 0.5% |

---

## 十、运行方式

### 10.1 启动命令

```bash
# 设置环境变量
export GATE_KLG_API_KEY="your_api_key"
export GATE_KLG_API_SECRET="your_api_secret"
export TG_BOT_TOKEN="your_bot_token"
export TG_CHAT_ID="your_chat_id"

# 启动策略
PYTHONPATH=src python scripts/run.py --config configs/config.yaml
```

### 10.2 模式切换

```yaml
# 实盘模式
dry_run: false

# 模拟模式
dry_run: true
```

### 10.3 显示面板

策略运行时显示实时 UI：

```
┌─────────────────────────────────────────────────────────────┐
│ Key Level Grid Strategy | BTCUSDT | $90,486.80 | 周期: 4h  │
├──────────────────┬──────────────────┬───────────────────────┤
│   📋 当前挂单    │   💰 账户信息    │    📍 关键价位       │
├──────────────────┼──────────────────┼───────────────────────┤
│   卖单           │   总余额: 799    │   阻力位             │
│   #1 91,503 ...  │   可用: 444      │   93,057 +2.84%      │
│   ───            │   杠杆: 10x      │   91,503 +1.12%      │
│   买单           │   止损线: 89,184 │   ───                │
│   (无)           │                  │   支撑位             │
│                  │                  │   89,632 -0.94%      │
├──────────────────┴──────────────────┴───────────────────────┤
│                    📊 当前持仓                               │
│   方向: 多头 | 数量: 0.0391 BTC | 价值: 3,537 USDT         │
│   均价: 90,124 | 盈亏: +14.00 USDT (+0.40%)                 │
└─────────────────────────────────────────────────────────────┘
```

---

## 十一、版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v2.3.0 | 2026-01-09 | 多周期融合、Telegram Bot 交互 |
| v2.2.0 | 2026-01-08 | 状态持久化、网格自动重建 |
| v2.1.0 | 2026-01-07 | Gate.io 执行器、实盘支持 |
| v2.0.0 | 2026-01-06 | 架构重构、模块化设计 |
| v1.0.0 | 2026-01-05 | 初始版本、信号展示 |

---

*文档版本: v1.0*  
*创建日期: 2026-01-09*  
*最后更新: 2026-01-09*
