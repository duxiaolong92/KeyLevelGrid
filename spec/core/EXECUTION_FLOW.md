# Key Level Grid 执行流程图

> 本文档详细描述策略的完整执行流程和配置参数

## 一、项目整体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Key Level Grid Strategy                              │
│                     (基于支撑/阻力位的网格交易策略)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                    启动脚本 (scripts/backtest/run.py)               │    │
│  │                                                                     │    │
│  │   1. 解析命令行参数 (argparse)                                      │    │
│  │   2. 加载配置文件 (configs/config.yaml)                             │    │
│  │   3. 初始化策略 (KeyLevelGridStrategy.from_yaml)                    │    │
│  │   4. 创建回测数据源/执行器                                          │    │
│  │   5. 拉取历史K线数据                                                │    │
│  │   6. 逐根K线回放执行策略                                            │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                      │                                      │
│                                      ▼                                      │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │                    策略核心 (KeyLevelGridStrategy)                   │    │
│  ├────────────────────────────────────────────────────────────────────┤    │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │    │
│  │   │ K线数据源     │  │ 支撑/阻力计算 │  │ 网格仓位管理  │            │    │
│  │   │ (KlineFeed)  │  │(Resistance)  │  │(GridPosition)│            │    │
│  │   └──────────────┘  └──────────────┘  └──────────────┘            │    │
│  │          │                  │                  │                  │    │
│  │          ▼                  ▼                  ▼                  │    │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │    │
│  │   │ 执行器       │  │ Recon 对账   │  │ 通知系统      │            │    │
│  │   │ (Executor)   │  │(ReconEvent)  │  │(Telegram)    │            │    │
│  │   └──────────────┘  └──────────────┘  └──────────────┘            │    │
│  └────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、回测执行流程 (scripts/backtest/run.py)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           run_backtest(args) 主流程                           │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 1: 初始化策略                                                           │
│ ────────────────────────────────────────────────────────────────────────── │
│                                                                             │
│   strategy = KeyLevelGridStrategy.from_yaml(args.config)                    │
│                                                                             │
│   • 加载 YAML 配置文件                                                      │
│   • 初始化各子模块:                                                         │
│     - GateKlineFeed (K线数据源)                                             │
│     - KeyLevelGridIndicator (指标计算)                                      │
│     - MultiTimeframeManager (多周期管理)                                    │
│     - ResistanceCalculator (支撑/阻力计算)                                  │
│     - KeyLevelPositionManager (仓位管理)                                    │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 2: 回测模式配置                                                         │
│ ────────────────────────────────────────────────────────────────────────── │
│                                                                             │
│   # 禁用 Telegram 通知                                                       │
│   strategy.config.tg_enabled = False                                         │
│                                                                             │
│   # 替换为回测数据源                                                         │
│   backtest_feed = BacktestKlineFeed(kline_config)                            │
│   strategy.kline_feed = backtest_feed                                        │
│                                                                             │
│   # 创建回测执行器                                                           │
│   executor = BacktestExecutor(                                               │
│       symbol=gate_symbol,           # 交易对 (如 BTC_USDT)                   │
│       initial_balance=10000,        # 初始资金 USDT                          │
│       contract_size=0.0001,         # 合约大小 (BTC/张)                      │
│       leverage=10,                  # 杠杆倍数                               │
│       min_contracts=1.0,            # 最小下单张数                           │
│   )                                                                          │
│   strategy._executor = executor                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 3: 拉取历史K线数据                                                      │
│ ────────────────────────────────────────────────────────────────────────── │
│                                                                             │
│   # 解析时间范围                                                             │
│   start_ms = _parse_datetime(args.start)  # 如 "2024-01-01"                 │
│   end_ms = _parse_datetime(args.end)      # 如 "2024-12-31"                 │
│                                                                             │
│   # 从 Gate.io API 拉取 K线                                                  │
│   async with aiohttp.ClientSession() as session:                             │
│       # 主周期 K线 (如 4h)                                                   │
│       primary_klines = await _fetch_gate_klines_range(...)                   │
│       backtest_feed.set_klines(primary_timeframe, primary_klines)            │
│                                                                             │
│       # 辅助周期 K线 (如 1d, 1w)                                             │
│       for tf in auxiliary_timeframes:                                        │
│           aux_klines = await _fetch_gate_klines_range(...)                   │
│           backtest_feed.set_klines(tf, aux_klines)                           │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 4: 逐根 K 线回放                                                        │
│ ────────────────────────────────────────────────────────────────────────── │
│                                                                             │
│   for kline in primary_klines:                                               │
│       ┌──────────────────────────────────────────────────────────────────┐  │
│       │ 4.1 推进时间                                                      │  │
│       │     backtest_feed.advance_to(kline.timestamp)                    │  │
│       │     • 更新各周期 K 线缓存到当前时间点                              │  │
│       └──────────────────────────────────────────────────────────────────┘  │
│                              │                                              │
│                              ▼                                              │
│       ┌──────────────────────────────────────────────────────────────────┐  │
│       │ 4.2 重置同步时间戳 (强制每根K线同步)                              │  │
│       │     strategy._balance_updated_at = 0                              │  │
│       │     strategy._orders_updated_at = 0                               │  │
│       │     strategy._position_updated_at = 0                             │  │
│       └──────────────────────────────────────────────────────────────────┘  │
│                              │                                              │
│                              ▼                                              │
│       ┌──────────────────────────────────────────────────────────────────┐  │
│       │ 4.3 执行策略更新周期                                              │  │
│       │     await strategy._update_cycle()                                │  │
│       │     • 详见下方 "_update_cycle 详细流程"                            │  │
│       └──────────────────────────────────────────────────────────────────┘  │
│                              │                                              │
│                              ▼                                              │
│       ┌──────────────────────────────────────────────────────────────────┐  │
│       │ 4.4 撮合订单                                                      │  │
│       │     executor.match_with_kline(kline)                              │  │
│       │     • 检查买单: low <= order.price <= high → 成交                  │  │
│       │     • 检查卖单: low <= order.price <= high → 成交                  │  │
│       │     • 计算保证金、仓位、盈亏                                       │  │
│       └──────────────────────────────────────────────────────────────────┘  │
│                              │                                              │
│                              ▼                                              │
│       ┌──────────────────────────────────────────────────────────────────┐  │
│       │ 4.5 记录权益曲线                                                  │  │
│       │     equity_curve.append(executor.get_equity())                    │  │
│       └──────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Step 5: 输出回测结果                                                         │
│ ────────────────────────────────────────────────────────────────────────── │
│                                                                             │
│   • 交易次数                                                                │
│   • 胜率 = wins / (wins + losses)                                           │
│   • 总收益 (USDT)                                                           │
│   • 最大回撤 = max((peak - current) / peak)                                 │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、策略核心更新周期 (_update_cycle)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        _update_cycle() 详细流程                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
    ┌──────────────────────────────────┼──────────────────────────────────┐
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 1. 获取最新 K 线数据                                         │    │
    │  │    klines = await kline_feed.get_latest_klines(timeframe)   │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 2. 首次运行: 更新账户余额                                    │    │
    │  │    if self._balance_updated_at == 0:                        │    │
    │  │        await self._update_account_balance()                 │    │
    │  │        # 用真实余额覆盖配置的 total_capital                  │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 3. 恢复网格状态 (仅一次)                                     │    │
    │  │    if not self._restored_state:                             │    │
    │  │        restored = position_manager.restore_state(price)     │    │
    │  │        # 从 JSON 文件恢复水位、持仓清单、挂单                 │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 4. 同步止损单 (仅一次)                                       │    │
    │  │    if not self._sl_synced_from_exchange:                    │    │
    │  │        await self._sync_stop_loss_from_exchange()           │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 5. 计算通道状态 (指标)                                       │    │
    │  │    self._current_state = self.indicator.calculate(klines)   │    │
    │  │    # 计算 MACD/RSI/ATR 等指标 (辅助判断)                     │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 6. 定期同步交易所数据                                        │    │
    │  │    • 账户余额 (每 60s)                                       │    │
    │  │    • 挂单列表 (每 30s)                                       │    │
    │  │    • 持仓信息 (每 15s)                                       │    │
    │  │    • 成交记录 (每 60s)                                       │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 7. 首次创建网格                                              │    │
    │  │    if not self._grid_created:                               │    │
    │  │        await self._create_initial_grid(klines)              │    │
    │  │        # 详见下方 "网格创建流程"                              │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 8. Recon 对账轨道 (周期性)                                   │    │
    │  │    await self._run_recon_track()                            │    │
    │  │    • 每 recon_interval_sec 执行一次                          │    │
    │  │    • 校验持仓清单与交易所一致性                               │    │
    │  │    • 构建并执行 Recon 动作 (挂单/撤单)                        │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 9. Event 增量轨道 (实时)                                     │    │
    │  │    await self._run_event_track()                            │    │
    │  │    • 响应成交事件                                            │    │
    │  │    • 快速补挂卖单                                            │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 10. 检测并更新止损单                                         │    │
    │  │     await self._check_and_update_stop_loss_order()          │    │
    │  │     • 检测止损触发                                           │    │
    │  │     await self._check_stop_loss_triggered()                 │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────────┘
```

---

## 四、网格创建流程 (create_grid)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     position_manager.create_grid() 流程                       │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
    ┌──────────────────────────────────┼──────────────────────────────────┐
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 1. 汇总原始价位                                              │    │
    │  │    all_raw_levels = support_levels + resistance_levels      │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 2. 强度过滤                                                  │    │
    │  │    qualified = [l for l if l.strength >= min_strength]      │    │
    │  │    # 只保留 >= 80 分的价位 (由 resistance.min_strength 控制) │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 3. 全局去重                                                  │    │
    │  │    final_pool = _deduplicate_all(qualified)                 │    │
    │  │    # 相近价位 (0.5% 内) 保留强度更高者                        │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 4. 划分支撑/阻力                                             │    │
    │  │    supports = [l for l if l.price < current_price]          │    │
    │  │    resistances = [l for l if l.price > current_price]       │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 5. 排序并限制数量                                            │    │
    │  │    supports = sorted(supports, reverse=True)[:max_grids]    │    │
    │  │    resistances = sorted(resistances)[:max_grids]            │    │
    │  │    # supports: 价格从高到低 (近 → 远)                         │    │
    │  │    # resistances: 价格从低到高 (近 → 远)                      │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 6. 计算网格区间                                              │    │
    │  │    if range_mode == "manual":                               │    │
    │  │        upper_price = manual_upper  # 如 180000              │    │
    │  │        lower_price = manual_lower  # 如 80000               │    │
    │  │    else:  # auto                                            │    │
    │  │        upper_price = resistances[0].price                   │    │
    │  │        lower_price = supports[-1].price                     │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 7. 计算网格底线 (止损线)                                     │    │
    │  │    grid_floor = lower_price × (1 - floor_buffer)            │    │
    │  │    # 如 lower_price=80000, floor_buffer=0.5%                 │    │
    │  │    # grid_floor = 80000 × 0.995 = 79600                     │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 8. 计算每网格资金分配                                        │    │
    │  │    max_position = total_capital × max_capital_usage         │    │
    │  │    per_grid_usdt = max_position / num_supports              │    │
    │  │    per_grid_btc = per_grid_usdt / price × leverage          │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 9. 生成买入订单 (支撑位)                                     │    │
    │  │    for support in supports:                                 │    │
    │  │        buy_order = GridOrder(                               │    │
    │  │            price=support.price,                             │    │
    │  │            quantity=per_grid_btc,                           │    │
    │  │            side="buy",                                      │    │
    │  │            level_id=support.level_id                        │    │
    │  │        )                                                    │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 10. 生成卖出订单 (阻力位)                                    │    │
    │  │     for resistance in resistances:                          │    │
    │  │         sell_order = GridOrder(                             │    │
    │  │             price=resistance.price,                         │    │
    │  │             quantity=0,  # 待分配                            │    │
    │  │             side="sell",                                    │    │
    │  │             level_id=resistance.level_id                    │    │
    │  │         )                                                   │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 11. 构建逐级邻位映射                                         │    │
    │  │     level_mapping = build_level_mapping()                   │    │
    │  │     # 每个支撑位 → 对应的目标阻力位                           │    │
    │  │     # 用于买入成交后挂卖单                                   │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 12. 持久化保存状态                                           │    │
    │  │     self._save_state()                                      │    │
    │  │     # 保存到 state/key_level_grid/{symbol}_state.json       │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────────┘
```

---

## 五、支撑/阻力位计算流程 (ResistanceCalculator)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│              ResistanceCalculator.calculate_support_levels() 流程            │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
    ┌──────────────────────────────────┼──────────────────────────────────┐
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 1. 多周期 K 线输入                                           │    │
    │  │    klines_by_timeframe = {                                  │    │
    │  │        "4h": primary_klines,   # 主周期                      │    │
    │  │        "1d": klines_1d,        # 辅助周期 1                   │    │
    │  │        "1w": klines_1w,        # 辅助周期 2                   │    │
    │  │    }                                                        │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 2. 单周期计算 (每个周期)                                     │    │
    │  │    _calculate_single_timeframe()                            │    │
    │  │                                                             │    │
    │  │    ┌─────────────────────────────────────────────────────┐  │    │
    │  │    │ 2.1 多尺度摆动点识别                                  │  │    │
    │  │    │     swing_lookbacks = [5, 13, 34]                    │  │    │
    │  │    │     • 5: 短期摆动点 (近期高低点)                       │  │    │
    │  │    │     • 13: 中期摆动点                                  │  │    │
    │  │    │     • 34: 长期摆动点 (重要历史高低点)                  │  │    │
    │  │    └─────────────────────────────────────────────────────┘  │    │
    │  │    ┌─────────────────────────────────────────────────────┐  │    │
    │  │    │ 2.2 成交量密集区识别 (Volume Profile)                 │  │    │
    │  │    │     • 将价格分桶 (bucket_pct = 1%)                    │  │    │
    │  │    │     • 统计每桶成交量                                  │  │    │
    │  │    │     • 取 Top 20% 成交量节点                           │  │    │
    │  │    └─────────────────────────────────────────────────────┘  │    │
    │  │    ┌─────────────────────────────────────────────────────┐  │    │
    │  │    │ 2.3 斐波那契扩展位                                    │  │    │
    │  │    │     fib_ratios = [1.0, 1.272, 1.618, 2.0, 2.618]     │  │    │
    │  │    │     • 基于近期波段计算斐波那契位                       │  │    │
    │  │    └─────────────────────────────────────────────────────┘  │    │
    │  │    ┌─────────────────────────────────────────────────────┐  │    │
    │  │    │ 2.4 心理关口 (整数价位)                               │  │    │
    │  │    │     • 如 100000, 90000, 80000...                     │  │    │
    │  │    │     • 根据价格量级自动选择步长                         │  │    │
    │  │    └─────────────────────────────────────────────────────┘  │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 3. 多周期融合                                                │    │
    │  │    _fuse_multi_timeframe()                                  │    │
    │  │    • 相近价位 (0.5% 内) 合并                                 │    │
    │  │    • 多周期共振: 强度 × (1 + mtf_boost)                      │    │
    │  │    • 标记 timeframe = "multi"                               │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 4. 合并相近价位                                              │    │
    │  │    _merge_levels()                                          │    │
    │  │    • 容差: merge_tolerance = 0.5%                           │    │
    │  │    • 保留强度最高的价位                                      │    │
    │  │    • 多来源叠加强度加成                                      │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 5. 过滤                                                      │    │
    │  │    _filter_levels()                                         │    │
    │  │    • 最小距离: min_distance_pct = 0.01% (过滤太近)           │    │
    │  │    • 最大距离: max_distance_pct = 30% (过滤太远)             │    │
    │  │    • 方向过滤: 支撑 < 现价, 阻力 > 现价                       │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    │                                  │                                   │
    │                                  ▼                                   │
    │  ┌─────────────────────────────────────────────────────────────┐    │
    │  │ 6. 综合排序                                                  │    │
    │  │    _sort_levels()                                           │    │
    │  │    • 评分 = 强度 × 0.6 + 距离分 × 0.4                        │    │
    │  │    • 按评分降序排列                                          │    │
    │  └─────────────────────────────────────────────────────────────┘    │
    └─────────────────────────────────────────────────────────────────────┘
```

---

## 六、配置参数详解

### 6.1 策略基础配置 (`strategy`)

| 参数 | 值 | 说明 |
|------|------|------|
| `name` | "KeyLevelGrid" | 策略名称 |
| `version` | "2.0.0" | 策略版本 |
| `description` | "基于支撑/阻力位的网格交易策略" | 策略描述 |

### 6.2 运行模式

| 参数 | 值 | 说明 |
|------|------|------|
| `dry_run` | `false` | `false` = 实盘模式，`true` = 模拟模式（不实际下单） |

### 6.3 交易配置 (`trading`)

| 参数 | 示例值 | 说明 |
|------|--------|------|
| `symbol` | "BTCUSDT" | 交易对符号 |
| `exchange` | "gate" | 交易所 (Gate.io) |
| `market_type` | "futures" | 市场类型: `futures` (合约), `spot` (现货) |
| `margin_mode` | "isolated" | 保证金模式: `cross` (全仓), `isolated` (逐仓) |
| `leverage` | 10 | 杠杆倍数 (1-100) |
| `timeframe` | "4h" | 主交易周期 (K线周期) |
| `aux_timeframes` | ["1d", "1w"] | 辅助周期列表 (多周期融合，最多2个) |
| `default_contract_size` | 0.0001 | 合约大小后备值 (每张合约代表多少BTC) |

### 6.4 K线数据源配置 (`kline_feed`)

| 参数 | 示例值 | 说明 |
|------|--------|------|
| `history_bars` | 500 | 加载的历史K线数量 |
| `update_interval_sec` | 5 | 轮询更新间隔 (秒) |
| `use_websocket` | `true` | 是否使用 WebSocket 实时推送 |
| `max_retries` | 3 | API 请求最大重试次数 |
| `request_timeout_sec` | 10.0 | 请求超时时间 (秒) |

### 6.5 网格配置 (`grid`) - 核心参数

| 参数 | 示例值 | 说明 |
|------|--------|------|
| `range_mode` | "manual" | 区间模式: `auto` (基于S/R自动计算), `manual` (手动设置) |
| `manual_upper` | 180000 | manual模式: 网格上边界价格 |
| `manual_lower` | 80000 | manual模式: 网格下边界价格 |
| `count_mode` | "by_levels" | 数量模式: `by_levels` (按有效支撑位数量), `fixed` (固定数量) |
| `max_grids` | 50 | 最大网格数量 |
| `floor_buffer` | 0.005 | 网格底线缓冲 (最低支撑位下方 0.5% 为止损线) |
| `sell_quota_ratio` | 0.7 | 动态止盈比例 (持仓的70%用于止盈挂单) |
| `min_profit_pct` | 0.0001 | 均价利润保护阈值 |
| `buy_price_buffer_pct` | 0.005 | 买单空间缓冲 (低于支撑位 0.5% 挂买单) |
| `sell_price_buffer_pct` | 0.002 | 卖单空间缓冲 |
| `base_amount_per_grid` | 0.001 | 标准网格单位 (BTC合约张数) |
| `max_fill_per_level` | 3 | 单水位最大补买次数 |
| `base_position_locked` | 0.0 | 固定底仓数量 (不参与止盈的BTC数量) |
| `recon_interval_sec` | 30 | Recon 对账周期 (秒) |
| `order_action_timeout_sec` | 10 | 挂单/撤单超时时间 (秒) |
| `restore_state_enabled` | `true` | 是否从持久化文件恢复网格状态 |

### 6.6 仓位配置 (`position`)

| 参数 | 示例值 | 说明 |
|------|--------|------|
| `max_capital_usage` | 0.8 | 最大资金使用率 (80%，留20%缓冲) |

### 6.7 止损配置 (`stop_loss`)

| 参数 | 示例值 | 说明 |
|------|--------|------|
| `mode` | "total" | 止损模式: `total` (统一止损，不对单个网格止损) |
| `trigger` | "grid_floor" | 触发条件: `grid_floor` (跌破网格底线), `fixed_pct` (固定比例) |

### 6.8 支撑/阻力位配置 (`resistance`)

| 参数 | 示例值 | 说明 |
|------|--------|------|
| `min_strength` | 80 | 最小强度阈值 (只使用 >= 80 分的价位) |
| `swing_lookbacks` | [5, 13, 34] | 摆动高低点回看周期 (短/中/长期) |
| `fib_ratios` | [0.382, 0.5, 0.618, 1.0, 1.618] | 斐波那契比例 |
| `psychological_enabled` | `true` | 是否启用心理关口 |
| `volume_profile_enabled` | `true` | 是否启用成交量密集区 |
| `volume_buckets` | 50 | 价格分桶数 |
| `volume_top_n` | 5 | 取 Top N 成交量节点 |
| `volume_bucket_pct` | 0.01 | 价格分桶百分比 (1%) |
| `volume_top_pct` | 0.20 | Top 20% 成交量区 |
| `mtf_boost` | 0.30 | 多周期叠加强度提升 (30%) |
| `merge_tolerance` | 0.005 | 合并相近价位容差 (0.5%) |
| `min_distance_pct` | 0.0001 | 最小距离过滤 (0.01%，过滤太近的价位) |
| `max_distance_pct` | 0.30 | 最大距离过滤 (30%，过滤太远的价位) |

### 6.9 日志配置 (`logging`)

| 参数 | 示例值 | 说明 |
|------|--------|------|
| `level` | "DEBUG" | 日志级别: DEBUG/INFO/WARNING/ERROR |
| `file` | "logs/key_level_grid.log" | 日志文件路径 |
| `console` | `true` | 是否输出到控制台 |

### 6.10 API 配置 (`api`)

| 参数 | 示例值 | 说明 |
|------|--------|------|
| `key_env` | "GATE_KLG_API_KEY" | API Key 环境变量名 |
| `secret_env` | "GATE_KLG_API_SECRET" | API Secret 环境变量名 |
| `passphrase_env` | "" | Passphrase 环境变量名 (可选) |

### 6.11 Telegram 通知配置 (`telegram`)

| 参数 | 示例值 | 说明 |
|------|--------|------|
| `enabled` | `true` | 是否启用 Telegram 通知 |
| `bot_token_env` | "TG_BOT_TOKEN" | Bot Token 环境变量名 |
| `chat_id_env` | "TG_CHAT_ID" | Chat ID 环境变量名 |

**通知类型 (`notifications`):**

| 参数 | 示例值 | 说明 |
|------|--------|------|
| `startup` | `true` | 策略启动通知 |
| `shutdown` | `true` | 策略停止通知 |
| `error` | `true` | 错误通知 |
| `order_filled` | `true` | 订单成交通知 |
| `order_placed` | `false` | 订单挂单通知 |
| `orders_summary` | `true` | 挂单汇总通知 |
| `quota_event` | `true` | 配额事件通知 |
| `position_flux` | `true` | 仓位变化通知 |
| `order_sync` | `true` | 订单同步通知 |
| `system_info` | `true` | 系统信息通知 |
| `system_alert` | `true` | 系统告警通知 |
| `risk_warning` | `true` | 风险预警通知 |
| `near_stop_loss_pct` | 0.02 | 接近止损预警阈值 (2%) |
| `daily_summary` | `true` | 每日汇总通知 |
| `daily_summary_time` | "08:00" | 每日汇总时间 |
| `heartbeat` | `true` | 心跳通知 |
| `heartbeat_interval_hours` | 24 | 心跳间隔 (小时) |
| `heartbeat_idle_sec` | 3600 | 空闲超时 (秒) |
| `silent_mode` | `true` | 静默模式 (合并频繁通知) |
| `merge_fill_window_sec` | 5 | 成交合并窗口 (秒) |
| `min_notify_interval_sec` | 5 | 最小通知间隔 (秒) |

---

## 七、回测命令行参数

```bash
python scripts/backtest/run.py [参数]
```

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--config, -c` | "configs/config.yaml" | 配置文件路径 |
| `--start` | "" | 起始时间 (YYYY-MM-DD 或 YYYY-MM-DD HH:MM:SS) |
| `--end` | "" | 结束时间 (YYYY-MM-DD 或 YYYY-MM-DD HH:MM:SS) |
| `--initial-balance` | 10000.0 | 初始资金 (USDT) |
| `--contract-size` | 0.0 | 合约大小 (BTC/张)，0 表示使用配置文件值 |
| `--min-contracts` | 1.0 | 最小下单张数 |
| `--log-file` | None | 日志文件路径 |

---

## 八、核心数据结构

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              核心数据结构                                     │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Kline (K线数据)                                                      │    │
│  │ ───────────────────────────────────────────────────────────────────  │    │
│  │ • timestamp: int       # 开盘时间 (毫秒)                             │    │
│  │ • open: float          # 开盘价                                      │    │
│  │ • high: float          # 最高价                                      │    │
│  │ • low: float           # 最低价                                      │    │
│  │ • close: float         # 收盘价                                      │    │
│  │ • volume: float        # 成交量 (币)                                 │    │
│  │ • quote_volume: float  # 成交额 (USDT)                              │    │
│  │ • trades: int          # 成交笔数                                    │    │
│  │ • is_closed: bool      # 是否已收盘                                  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ PriceLevel (价格关键位)                                              │    │
│  │ ───────────────────────────────────────────────────────────────────  │    │
│  │ • price: float         # 价格                                        │    │
│  │ • level_type: LevelType # 类型 (SWING_HIGH/LOW/VOLUME_NODE/FIB/...)  │    │
│  │ • strength: float      # 强度 (0-100)                                │    │
│  │ • description: str     # 描述                                        │    │
│  │ • source: str          # 来源标识 (swing_5/volume_node/fib_0.618)    │    │
│  │ • touches: int         # 触及次数                                    │    │
│  │ • timeframe: str       # 识别周期 ("4h"/"1d"/"multi")                │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ GridState (网格状态)                                                 │    │
│  │ ───────────────────────────────────────────────────────────────────  │    │
│  │ • upper_price: float   # 网格上边界                                  │    │
│  │ • lower_price: float   # 网格下边界                                  │    │
│  │ • grid_floor: float    # 网格底线 (止损线)                           │    │
│  │ • support_levels_state: List[GridLevelState]  # 支撑位状态列表       │    │
│  │ • resistance_levels_state: List[GridLevelState] # 阻力位状态列表     │    │
│  │ • level_mapping: Dict  # 逐级邻位映射 (支撑位 → 目标阻力位)          │    │
│  │ • active_inventory: List[ActiveFill]  # 持仓清单                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ GridLevelState (网格水位状态)                                        │    │
│  │ ───────────────────────────────────────────────────────────────────  │    │
│  │ • level_id: str        # 水位唯一 ID                                 │    │
│  │ • price: float         # 价格                                        │    │
│  │ • strength: float      # 强度                                        │    │
│  │ • status: LevelStatus  # 状态 (PENDING/ACTIVE/FILLED/EXHAUSTED)      │    │
│  │ • fill_counter: int    # 买入成交次数                                │    │
│  │ • open_order_id: str   # 当前挂单 ID                                 │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ ActiveFill (持仓清单记录)                                            │    │
│  │ ───────────────────────────────────────────────────────────────────  │    │
│  │ • level_id: str        # 关联的支撑位 ID                             │    │
│  │ • level_index: int     # 支撑位索引                                  │    │
│  │ • price: float         # 成交价格                                    │    │
│  │ • qty: float           # 成交数量 (BTC)                              │    │
│  │ • timestamp: int       # 成交时间 (毫秒)                             │    │
│  │ • order_id: str        # 订单 ID                                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、Recon 对账机制 (双轨道)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                           Recon 对账机制                                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Recon 轨道 (周期性对账, 每 30 秒)                                   │     │
│  │ ──────────────────────────────────────────────────────────────────  │     │
│  │                                                                     │     │
│  │  1. 更新持仓快照                                                    │     │
│  │     position_manager.update_position_snapshot(holdings, avg_entry)  │     │
│  │                                                                     │     │
│  │  2. 配额对账 (reconcile_counters)                                   │     │
│  │     • 合并本地账本 + 交易所成交记录                                  │     │
│  │     • 补齐缺失的成交记录                                            │     │
│  │     • 校验 fill_counter 与 inventory 一致性                         │     │
│  │                                                                     │     │
│  │  3. 构建 Recon 动作                                                 │     │
│  │     actions = build_recon_actions()                                 │     │
│  │     • 买单处理: 检查挂单是否需要补挂/撤单重挂                        │     │
│  │     • 卖单处理: 按高价优先分配可卖量                                 │     │
│  │                                                                     │     │
│  │  4. 执行动作 (挂单/撤单)                                            │     │
│  │     await _execute_actions(actions)                                 │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ Event 轨道 (实时响应成交)                                           │     │
│  │ ──────────────────────────────────────────────────────────────────  │     │
│  │                                                                     │     │
│  │  1. 检测新成交                                                      │     │
│  │     • 对比本地记录和交易所成交                                       │     │
│  │                                                                     │     │
│  │  2. 买入成交处理                                                    │     │
│  │     • 更新水位 fill_counter                                         │     │
│  │     • 添加到 active_inventory                                       │     │
│  │     • 查找目标阻力位 (通过 level_mapping)                            │     │
│  │     • 快速补挂卖单                                                  │     │
│  │                                                                     │     │
│  │  3. 卖出成交处理                                                    │     │
│  │     • 从 active_inventory 移除 (FIFO)                               │     │
│  │     • 释放水位配额                                                  │     │
│  │     • 补挂买单                                                      │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │ 卖单分配策略 (高价优先)                                             │     │
│  │ ──────────────────────────────────────────────────────────────────  │     │
│  │                                                                     │     │
│  │  可卖总量 = (总持仓 - 锁定底仓) × sell_quota_ratio (70%)            │     │
│  │                                                                     │     │
│  │  分配顺序:                                                          │     │
│  │  1. 按支撑位价格从高到低排序                                        │     │
│  │  2. 每个支撑位的买入 → 对应的阻力位挂卖单                           │     │
│  │  3. 高价位优先消耗可卖配额                                          │     │
│  │                                                                     │     │
│  │  示例:                                                              │     │
│  │  支撑位 #1 (95000) 买入 0.01 BTC → 阻力位 #1 (98000) 挂卖            │     │
│  │  支撑位 #2 (93000) 买入 0.01 BTC → 阻力位 #2 (96000) 挂卖            │     │
│  │  支撑位 #3 (91000) 买入 0.01 BTC → 配额耗尽，不挂卖                  │     │
│  └────────────────────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 十、文件结构

```
KeyLevelGrid/
├── configs/                        # 配置文件目录
│   └── config.yaml                # 主配置文件
├── scripts/
│   ├── backtest/
│   │   └── run.py                 # 回测入口脚本
│   └── run/
│       └── single.py              # 实盘单策略运行脚本
├── src/key_level_grid/
│   ├── analysis/
│   │   └── resistance.py          # 支撑/阻力位计算
│   ├── core/
│   │   ├── config.py              # 配置数据类
│   │   ├── models.py              # 核心数据模型
│   │   ├── state.py               # 网格状态
│   │   └── types.py               # 类型定义
│   ├── data/feeds/
│   │   ├── backtest.py            # 回测数据源
│   │   └── gate.py                # Gate.io 数据源
│   ├── executor/
│   │   ├── backtest_executor.py   # 回测执行器
│   │   └── gate_executor.py       # Gate.io 执行器
│   ├── strategy/
│   │   ├── recon.py               # Recon 对账
│   │   └── display.py             # 显示模块
│   ├── position.py                # 仓位管理器
│   ├── strategy_main.py           # 策略主类
│   └── telegram/
│       └── notify.py              # Telegram 通知
└── state/                          # 持久化状态目录
    └── key_level_grid/
        └── {symbol}_state.json    # 网格状态文件
```

---

## 相关文档

- [OVERVIEW.md](./OVERVIEW.md) - 系统概览
- [LEVEL_LIFECYCLE.md](../features/LEVEL_LIFECYCLE.md) - 水位生命周期
- [SELL_MAPPING.md](../features/SELL_MAPPING.md) - 卖单映射机制
- [CONSTITUTION.md](../CONSTITUTION.md) - 开发准则
