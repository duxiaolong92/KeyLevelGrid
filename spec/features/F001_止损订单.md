# F001: 止损订单自动管理

## 状态: ✅ 已完成

## 背景

用户需要在持仓时自动维护止损单，确保策略崩溃或断网时仍能止损保护本金。

本地价格监控方案在策略崩溃时无法执行止损，因此采用交易所 Trigger Order（计划委托）。

---

## 用户故事

> 作为交易者，我希望系统在持仓变化时自动提交/更新止损单到交易所，
> 以便在策略崩溃/断网时仍能保护本金。

---

## 功能需求

### FR-001.1: 止损单提交
- 持仓从 0 变为 N 时，自动提交止损单
- 止损价格 = `grid_floor`（网格底线）
- 止损数量 = 当前持仓张数
- 订单类型 = Gate.io Trigger Order（计划委托）

### FR-001.2: 止损单更新
- 持仓增加时，更新止损数量
- 实现方式：先取消旧单，再提交新单
- 更新频率：每个 update_cycle（约 5 秒）检查一次

### FR-001.3: 止损单取消
- 持仓清空时，取消止损单
- 网格重建时，重置止损状态（因全部计划单已被取消）

---

## 技术方案

### 订单参数

```python
# Gate.io Trigger Order 参数
{
    'settle': 'usdt',
    'initial': {
        'contract': 'BTC_USDT',
        'size': -104,              # 负数 = 卖出
        'price': '0',              # 市价单
        'tif': 'ioc',              # 立即成交或取消
        'reduce_only': True        # 仅减仓
    },
    'trigger': {
        'strategy_type': 0,        # 0 = 单向触发
        'price_type': 1,           # 1 = 标记价格
        'price': '80197',          # 触发价格
        'rule': 2,                 # 2 = <= (价格跌破触发)
        'expiration': 2592000      # 30 天有效
    }
}
```

### 状态管理

```python
# strategy.py 中的状态变量
self._stop_loss_order_id: str = None       # 止损单 ID
self._stop_loss_contracts: int = 0          # 止损张数
self._sl_order_updated_at: float = 0        # 更新时间戳
```

### 关键方法

| 方法 | 职责 |
|------|------|
| `_check_and_update_stop_loss_order()` | 检查持仓变化，决定是否更新止损单 |
| `_submit_stop_loss_order(contracts, trigger_price)` | 提交止损计划委托 |
| `_cancel_stop_loss_order()` | 取消现有止损单 |

### 调用时机

```python
# strategy.py - _update_cycle()
async def _update_cycle(self):
    # ... 其他逻辑 ...
    
    # 检查止盈单
    await self._check_and_submit_take_profit_orders()
    
    # 检查止损单（新增）
    await self._check_and_update_stop_loss_order()
```

### 网格重建时重置

```python
# _maybe_rebuild_grid() 和 force_rebuild_grid()
# 取消所有计划单后，重置止损状态
self._stop_loss_order_id = None
self._stop_loss_contracts = 0
```

---

## 验收标准

- [x] 开仓后 10 秒内提交止损单
- [x] Gate.io「当前委托」→「计划委托」中可见止损单
- [x] 仓位增加时止损数量同步更新
- [x] 清仓后止损单被取消
- [x] 网格重建后能重新提交止损单

---

## 相关代码

| 文件 | 位置 | 说明 |
|------|------|------|
| `strategy.py` | 1050-1180 行 | 止损单检查和提交逻辑 |
| `gate_executor.py` | `submit_order()` | Trigger Order 提交 |
| `base.py` | `Order` 类 | 订单数据结构 |

---

## 已知问题

1. **启动时不检查现有止损单**：如果策略重启前已有止损单，可能重复提交
   - 解决方案：启动时查询交易所现有计划委托（待实现）

2. **止损触发无专门通知**：止损成交时走普通成交通知
   - 解决方案：在成交通知中识别止损单（待实现）

---

*文档版本: v1.0*  
*创建日期: 2026-01-10*
