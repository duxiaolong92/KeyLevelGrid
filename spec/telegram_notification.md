# Telegram 通知模块需求规格

## 概述

增强 Telegram 通知模块，实现策略运行状态的实时推送，让用户随时掌握交易动态。

### ⚠️ 计价规则

**所有金额统一使用 USDT 计价**，包括：
- 持仓价值
- 成交金额
- 挂单金额
- 盈亏金额
- 账户余额

不显示 BTC 数量或合约张数，保持通知简洁易读。

---

## 一、用户需求

### 1.1 系统启动通知
**触发时机**：策略启动完成后  
**通知内容**：
- 策略名称、交易对
- 当前价格
- 账户余额（总余额、可用余额，USDT）
- 网格配置（最大仓位 USDT、杠杆、网格数）
- 当前挂单列表（价格、金额 USDT）
- 当前持仓价值（USDT）及盈亏

### 1.2 异常错误通知
**触发时机**：系统出现任何异常  
**通知内容**：
- 错误类型
- 错误详细信息
- 发生位置（上下文）
- 发生时间
- 建议操作（如有）

### 1.3 成交通知
**触发时机**：订单成交时  
**通知内容**：
- 买入/卖出方向
- 成交价格
- 成交金额（USDT）
- 成交档位
- 成交后持仓价值（USDT）
- 成交后盈亏（USDT + 百分比）

### 1.4 挂单更新通知
**触发时机**：挂单发生变化时  
**通知内容**：
- 新增挂单：价格、数量、类型
- 取消挂单：原因
- 挂单汇总：当前买单/卖单数量

---

## 二、补充建议

### 2.1 策略状态通知

| 事件 | 触发时机 | 通知内容 |
|------|---------|---------|
| 策略启动 | `strategy.start()` 完成 | 配置摘要、账户状态 |
| 策略停止 | `strategy.stop()` 调用 | 停止原因、最终持仓 |
| 策略暂停 | 手动暂停或异常暂停 | 暂停原因 |
| 策略恢复 | 从暂停恢复 | 恢复确认 |

### 2.2 网格事件通知

| 事件 | 触发时机 | 通知内容 |
|------|---------|---------|
| 网格创建 | 首次建立网格 | 支撑位列表、每格金额 |
| 网格重建 | 价格偏离触发重建 | 重建原因、新网格配置 |
| 网格成交 | 买单成交 | 成交档位、剩余档位 |

### 2.3 风险预警通知

| 事件 | 触发条件 | 通知内容 |
|------|---------|---------|
| 接近止损 | 价格距止损线 < 2% | 当前价、止损价、距离 |
| 大额亏损 | 未实现亏损 > 阈值 | 亏损金额、百分比 |
| 余额不足 | 可用余额 < 单格保证金 | 余额状态、建议操作 |
| 杠杆过高 | 实际杠杆 > 配置杠杆 | 当前杠杆、风险提示 |

### 2.4 定时汇总通知

| 类型 | 发送时间 | 通知内容 |
|------|---------|---------|
| 每日汇总 | 每日 20:00 | 当日盈亏、成交次数、持仓状态 |
| 周报 | 每周日 20:00 | 本周盈亏、网格效率统计 |

### 2.5 心跳/存活通知
**目的**：确认系统正常运行  
**配置**：可选，默认关闭  
**频率**：每 4 小时发送一次  
**内容**：运行状态、当前价格、持仓概览

---

## 三、通知配置

### 3.1 配置结构

```yaml
telegram:
  # 基础配置
  enabled: true
  bot_token: "${TG_BOT_TOKEN}"
  chat_id: "${TG_CHAT_ID}"
  
  # 通知开关
  notifications:
    # 必要通知（建议开启）
    startup: true              # 启动通知
    shutdown: true             # 停止通知
    error: true                # 错误通知
    order_filled: true         # 成交通知
    
    # 可选通知
    order_placed: false        # 挂单通知（可能较频繁）
    order_cancelled: false     # 取消通知
    grid_rebuild: true         # 网格重建
    
    # 风险通知
    risk_warning: true         # 风险预警
    near_stop_loss_pct: 0.02   # 距止损预警阈值 2%
    
    # 汇总通知
    daily_summary: true        # 每日汇总
    daily_summary_time: "20:00"
    
    # 心跳（可选）
    heartbeat: false
    heartbeat_interval_hours: 4
```

### 3.2 通知级别

| 级别 | 说明 | 示例 |
|------|------|------|
| 🔴 紧急 | 需要立即关注 | 错误、止损触发、大额亏损 |
| 🟡 重要 | 重要交易事件 | 成交、网格重建 |
| 🟢 普通 | 日常信息 | 挂单、每日汇总 |
| ⚪ 调试 | 详细调试信息 | 默认不发送 |

---

## 四、消息模板

### 4.1 启动通知
```
🚀 策略已启动

📊 BTCUSDT | Gate.io
├ 当前价格: $94,250.00
├ 账户余额: 800.00 USDT
├ 可用余额: 250.00 USDT
└ 杠杆: 10x

📋 当前挂单 (6个买单, 共4,938 USDT)
├ #1: $93,500 | 823 USDT
├ #2: $92,800 | 823 USDT
├ #3: $92,100 | 823 USDT
├ #4: $91,400 | 823 USDT
├ #5: $90,700 | 823 USDT
└ #6: $90,000 | 823 USDT

💼 当前持仓
├ 方向: 多头
├ 持仓价值: 956.53 USDT
├ 均价: $89,747.87
└ 盈亏: +15.50 USDT (+1.62%)
```

### 4.2 成交通知
```
✅ 订单成交

🟢 买入 BTCUSDT
├ 成交价: $93,500.00
├ 成交额: 823.00 USDT
└ 档位: #1 / 8

💼 持仓更新
├ 持仓价值: 1,779.53 USDT
├ 均价: $91,623.94
└ 盈亏: -25.30 USDT (-1.35%)
```

### 4.2.1 止盈成交通知
```
🎯 止盈成交

🔴 卖出 BTCUSDT
├ 成交价: $95,800.00
├ 成交额: 845.00 USDT
├ 实现盈亏: +52.30 USDT (+6.59%)
└ 档位: TP #1 / 2

💼 持仓更新
├ 剩余持仓: 934.53 USDT
├ 均价: $91,623.94
└ 未实现盈亏: +42.10 USDT (+4.51%)
```

### 4.3 错误通知
```
❌ 系统错误

⚠️ 类型: OrderSubmitError
├ 错误: Insufficient margin
├ 上下文: 提交买单 #7 @ $89,000
├ 时间: 2026-01-09 15:30:25
└ 建议: 检查账户余额或降低仓位

📊 当前状态
├ 可用余额: 12.50 USDT
└ 策略状态: 运行中
```

### 4.4 风险预警
```
⚠️ 风险预警

🔴 价格接近止损线！

├ 当前价格: $85,200.00
├ 止损价格: $84,000.00
├ 距离: -1.41%
├ 持仓价值: 1,850.00 USDT
├ 当前盈亏: -125.00 USDT (-6.76%)
└ 触发止损预计亏损: -185.00 USDT (-10.00%)

💡 建议: 关注市场走势，考虑是否手动干预
```

### 4.5 每日汇总
```
📊 每日汇总 - 2026-01-09

💰 今日盈亏
├ 实现盈亏: +45.50 USDT
├ 未实现盈亏: +12.30 USDT
└ 总计: +57.80 USDT

📈 交易统计
├ 买入成交: 3 次 (共 2,469 USDT)
├ 卖出成交: 2 次 (共 1,690 USDT)
├ 网格重建: 0 次
└ 错误次数: 0 次

💼 当前状态
├ 持仓价值: 1,413.75 USDT
├ 可用余额: 586.25 USDT
├ 总资产: 2,000.00 USDT
└ 网格档位: 3/8 已成交
```

---

## 五、技术实现要点

### 5.1 现有模块分析

已有文件：
- `telegram/bot.py` - Bot 核心，已实现命令处理
- `telegram/notify.py` - 通知管理，已有部分通知方法
- `telegram/commands.py` - 命令定义

需要增强：
1. 在 `notify.py` 中添加新的通知方法
2. 在策略关键点调用通知方法
3. 添加配置项控制通知开关

### 5.2 集成点

```
strategy.py
├── start()           → notify_startup()
├── stop()            → notify_shutdown()
├── _submit_grid_orders()  → notify_orders_placed()
├── _handle_order_filled() → notify_order_filled()
├── _rebuild_grid()   → notify_grid_rebuild()
└── 异常捕获          → notify_error()

gate_executor.py
├── submit_order()    → notify_order_placed()
└── 异常捕获          → notify_error()
```

### 5.3 防刷屏机制

- **合并通知**：短时间内多个同类事件合并发送
- **频率限制**：同类通知最小间隔 5 秒
- **静默时段**：可配置夜间静默（仅发送紧急通知）
- **消息队列**：异步发送，不阻塞主流程

---

## 六、优先级

| 优先级 | 功能 | 说明 |
|-------|------|------|
| P0 | 启动通知 | 用户核心需求 |
| P0 | 错误通知 | 用户核心需求 |
| P0 | 成交通知 | 用户核心需求 |
| P1 | 挂单更新通知 | 用户核心需求 |
| P1 | 风险预警 | 安全相关 |
| P2 | 网格重建通知 | 运维相关 |
| P2 | 每日汇总 | 增强体验 |
| P3 | 心跳通知 | 可选功能 |

---

## 七、待确认事项

1. **通知频率**：挂单更新是否每次都通知，还是汇总通知？
2. **静默时段**：是否需要夜间静默功能？
3. **多语言**：是否需要支持英文通知？
4. **通知确认**：部分操作（如平仓）是否需要确认按钮？
5. **图表发送**：是否需要发送 K 线截图或图表？

---

*文档版本: v1.0*  
*创建日期: 2026-01-09*
