# ============================================
# KeyLevelGrid V3.2.5 配置
# ============================================

# 运行模式
dry_run: false

# ============================================
# 交易配置 (必须)
# ============================================
trading:
  symbol: "BNBUSDT"
  exchange: "gate"
  market_type: "futures"
  margin_mode: "isolated"
  leverage: 3
  timeframe: "4h"
  aux_timeframes: ["1d"]
  default_contract_size: 0.01

# API 配置
api:
  key_env: "GATE_KLG_API_KEY"
  secret_env: "GATE_KLG_API_SECRET"

# 仓位配置
position:
  max_leverage: 3
  max_capital_usage: 0.8

# ============================================
# V3.2.5 功能开关
# ============================================
v3_features:
  level_generation_enabled: true
  kline_sync_enabled: true
  atomic_rebuild_enabled: true
  score_refresh_only: false
  log_level: "DEBUG"

# ============================================
# 网格配置
# ============================================
grid:
  max_levels: 10
  use_all_qualified: true
  min_profit_pct: 0.001
  base_amount_per_grid: 0.1  # BNB
  
  precision:
    price_tolerance: 0.0001
    qty_tolerance: 0.05
    merge_tolerance: 0.002
    snap_tolerance: 0.005
  
  # ===== V3.2.5 水位生成核心配置 =====
  level_generation:
    enabled: true
    
    # 四层级时间框架
    timeframes:
      l1_strategy:
        enabled: true
        interval: "1w"
        use_3d_fallback: true
        fib_lookback: [8, 21, 55]           # 简化: 单一周期
      l2_skeleton:
        interval: "1d"
        fib_lookback: [13, 34, 55, 89, 144]
        enabled: true
      l3_relay:
        interval: "4h"
        fib_lookback: [8, 21, 55, 89, 144, 233, 377, 610]
        enabled: true
      l4_tactical:
        enabled: true
        interval: "15m"
        fib_lookback: [34, 55, 144]
        triggers_rebuild: false
    
    # ATR 空间硬约束 (V3.2.5 核心)
    atr_constraint:
      enabled: true
      atr_period: 14
      atr_timeframe: "4h"
      gap_min_atr_ratio: 0.3
      gap_max_atr_ratio: 3.0
      fill_priority: ["tactical", "vpvr", "fibonacci"]
      fibonacci_fill_ratio: 0.618
      fibonacci_fill_score: 35
      fibonacci_enabled: true
    
    # 评分矩阵 (V3.2.5)
    scoring:
      timeframe_weights:
        "1w": 2.0
        "3d": 1.8
        "1d": 1.5
        "4h": 1.0
        "15m": 0.6
      period_scores:
        144: 100
        89: 80
        55: 60
        34: 45
        21: 35
        13: 25
        8: 15
      volume_weights:
        poc: 1.8
        hvn: 1.5
        normal: 1.0
        lvn: 0.4
      mtf_resonance:
        4: 2.5
        3: 2.0
        2: 1.5
        1: 1.0
      trend_coefficients:
        bullish:
          support: 1.1
          resistance: 0.9
        bearish:
          support: 0.9
          resistance: 1.1
        neutral:
          support: 1.0
          resistance: 1.0
      min_score_threshold: 30
      display_score_threshold: 20
    
    # 重构触发 (仅 L2 1d 55x 锚点)
    rebuild_triggers:
      anchor_timeframe: "1d"
      anchor_period: 55
      anchor_drift_threshold: 0.03
      cooldown_sec: 900
      coverage_alert_levels: 1
    
    # 静默刷新 (4h/15m 只更新评分，不改挂单)
    silent_refresh:
      enabled: true
      timeframes: ["4h", "15m"]
      allow_score_update: true
      allow_qty_update: true
      forbid_price_change: true
    
    # K 线同步
    kline_sync:
      enabled: true
      max_desync_tolerance_sec: 60
      max_lag:
        "1w": 600
        "3d": 600
        "1d": 300
        "4h": 60
        "15m": 30

    # 手动边界 (默认关闭)
    manual_boundary:
      enabled: false
      upper_price: 100000.0
      lower_price: 85000.0
      mode: "strict"
      buffer_pct: 0.01

# ============================================
# 可选配置 (按需启用)
# ============================================

# # 告警配置
# alerts:
#   telegram_enabled: true
#   alarm_on_rebuild_fail: true
#   alarm_on_sync_fail: true
#   daily_summary_enabled: true

# # 日志配置
# logging:
#   level: "DEBUG"
#   format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
#   file: "logs/v3_staging.log"
#   max_bytes: 10485760
#   backup_count: 5
